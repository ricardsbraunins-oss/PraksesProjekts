<script type="module">
import { supabase } from './supabase.js';

// Cooldown function moved OUTSIDE click handler
function startCooldown(seconds) {
  const msgEl = document.getElementById("message");
  const sendBtn = document.getElementById("send");

  sendBtn.disabled = true;
  let timeLeft = seconds;
  msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`;

  const interval = setInterval(() => {
    timeLeft--;
    msgEl.innerText = `Saved! Cooldown: ${timeLeft}s`;

    if (timeLeft <= 0) {
      clearInterval(interval);
      msgEl.innerText = "Ready!";
      sendBtn.disabled = false;
    }
  }, 1000);
}

document.getElementById("send").addEventListener("click", async () => {
  const q1 = document.getElementById("q1").value;
  const q2 = document.getElementById("q2").value;
  const q3 = document.getElementById("q3").value;

  // VALIDATION
  if (q1.length < 3 || q2.length < 3) {
    document.getElementById("message").innerText = "First 2 fields need at least 3 characters!";
    return;
  }

  if (!q3 || q3 <= 0) {
    document.getElementById("message").innerText = "Age must be a positive number!";
    return;
  }

  const { error } = await supabase
    .from('responses')
    .insert([{ q1, q2, q3 }]);

  if (error) {
    document.getElementById("message").innerText = "Error: " + error.message;
    return;
  }

  startCooldown(10);
});
</script>
