<!DOCTYPE html>
<html>
<head>
  <title>Admin – All Todos</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <h2>ADMIN PANEL — Visi lietotāju uzdevumi</h2>
  <p style="color:red;">Tikai administratoram!</p>

  <!-- Tabula ar visiem lietotāju uzdevumiem -->
  <table border="1" id="adminTodoTable">
    <tr>
      <th>Lietotājs</th>
      <th>Uzdevums</th>
      <th>Veids</th>
      <th>Svarīgums</th>
      <th>Pabeigts</th>
      <th>Dzēst</th>
    </tr>
  </table>

  <br>
  <button onclick="window.location.href='index.html'">Atpakaļ</button>

  <script type="module">
    import { supabase } from "./supabase.js"

    // Pārbauda vai lietotājs ir admin
    const username = localStorage.getItem("username")
    if (username !== "admin") {
      alert("Access denied! Only admin can view this page.")
      window.location.href = "index.html"
    }

    // Ielādē visus Todo ierakstus no datubāzes
    async function loadAllTodos() {
      const { data, error } = await supabase
        .from("todolist")
        .select("*")
        .order("username", { ascending: true })

      // Ja ir kļūda
      if (error) {
        alert("Error: " + error.message)
        return
      }

      const table = document.getElementById("adminTodoTable")

      // Ievieto katru todo tabulā
      data.forEach(row => {
        const newRow = table.insertRow()

        newRow.insertCell(0).innerText = row.username
        newRow.insertCell(1).innerText = row.uzd
        newRow.insertCell(2).innerText = row.uzdveids
        newRow.insertCell(3).innerText = row.svarigums

        // Checkbox lai atzīmētu pabeigšanu
        const checkCell = newRow.insertCell(4)
        const checkbox = document.createElement("input")
        checkbox.type = "checkbox"
        checkbox.style.width = "22px"
        checkbox.style.height = "22px"
        checkbox.checked = row.pabeigts === true

        // Atjauno statusu datubāzē
        checkbox.addEventListener("change", async () => {
          await supabase
            .from("todolist")
            .update({ pabeigts: checkbox.checked })
            .eq("id", row.id)
        })

        checkCell.appendChild(checkbox)

        // Dzēšanas poga
        const deleteCell = newRow.insertCell(5)
        const deleteBtn = document.createElement("button")
        deleteBtn.innerText = "X"
        deleteBtn.style.width = "80px"
        deleteBtn.style.color = "red"

        deleteBtn.addEventListener("click", async () => {
          if (!confirm("Tiešām dzēst šo uzdevumu?")) return

          await supabase
            .from("todolist")
            .delete()
            .eq("id", row.id)

          newRow.remove()
        })

        deleteCell.appendChild(deleteBtn)
      })
    }

    // Izsauc datu ielādi
    loadAllTodos()
  </script>

</body>
</html>
